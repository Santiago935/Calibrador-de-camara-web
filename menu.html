<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <title> MenuDeCamara </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

</head>

<body>

  <p id="status">OpenCV.js is loading...</p>

  <!--Accedo a OpenCV-->
  <script>
    var Module = {
      // https://emscripten.org/docs/api_reference/module.html#Module.onRuntimeInitialized
      onRuntimeInitialized() {
        document.getElementById('status').innerHTML = 'OpenCV.js is ready.';
        preparoVideo();
      }
    }; 
  </script>
  <!--Carga Asincronica del archivo opencv.js-->
  <script async src="opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>




  <div class=textoInicial>
    <h1>
      Introduccion
    </h1>
    <p> Por ahora esta pagina servira de prototipo para la calibraci√≥n de camara. <br>
      La idea es que el usuario abra la camara y atravez de la camara detecte <br>
      un patron de ajedrez.<br>
      Una vez detectado el patron, el usuario toma foto (entre 20 y 30), y el sistema<br>
      calcula la matriz y los coeficientes de distorcion, permitiendo al usuario descargarlo <br>
      como un archivo.
    </p>

    <h2>Su Camara: </h2>
  </div>


  <div class="camara">

    <video id="videoInput" width="640" height="480"></video> <canvas id="salida1" width="640" height="480"></canvas>
    <h3>Propiedades:</h3>
    <p id="propiedades"></p>

  </div>



  <div class="tableroReferencia">
    <img id="tablero" src="pattern_chessboard6x9.jpg" width="640" height="480">

  </div>



  <script type="text/javascript">

    //Pide y muestra el video en camara
    let video = document.getElementById('videoInput');

    let streaming = false; // Variable para controlar el estado del video
    let src, gris, cap;
    const FPS = 30;

    navigator.mediaDevices.getUserMedia({ video: true, audio: false })
      .then(function (stream) {
        video.srcObject = stream;
        video.play();
      })
      .catch(function (err) {
        console.error("Ocurrio un error: " + err);
      });

    
    //Evento donde obtengo y cargo las propiedades de la camara. 
    video.onloadedmetadata = function () {

      let width = video.videoWidth
      let height = video.videoHeight
      document.getElementById("propiedades").textContent = "Propiedades: " + width + "x" + height;

    };

    function preparoVideo(){

      video.addEventListener('loadeddata', () => {    //evento que activa automaticamente
        src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
        gris = new cv.Mat(video.height, video.width, cv.CV_8UC1);
        cap = new cv.VideoCapture(video);
        streaming = true;
        detectarYdibujarPatron();
      });


    }
    function detectarYdibujarPatron () {

      try {
        if (!streaming) {
          // clean and stop.
          src.delete();
          gris.delete();
          return;
        }
        let begin = Date.now();
        // start processing.
        cap.read(src);
        cv.cvtColor(src, gris, cv.COLOR_RGBA2GRAY);
        cv.imshow('salida1', gris);
        // schedule the next one.
        let delay = 1000 / FPS - (Date.now() - begin);
        setTimeout(detectarYdibujarPatron, delay);      //Esto es el que hara un bucle
      } catch (err) {
        console.error(err);
      }
    };





  </script>
</body>

</html>
